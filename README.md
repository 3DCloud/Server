# 3DCloud Server
[![GitHub Workflow Status](https://img.shields.io/github/workflow/status/3DCloud/Server/Rails?style=flat-square)](https://github.com/3DCloud/Server/actions/workflows/rails.yml)
[![Codecov](https://img.shields.io/codecov/c/github/3DCloud/Server?style=flat-square)](https://codecov.io/gh/3DCloud/Server)
[![License](https://img.shields.io/github/license/3DCloud/Server?style=flat-square)](https://github.com/3DCloud/Server/blob/main/LICENSE)

## Contributing
### Prerequisites
This project currently uses Ruby 3.0.2. We recommend installing it using [rbenv](https://github.com/rbenv/rbenv) and [ruby-build](https://github.com/rbenv/ruby-build). If you are on Windows, we recommend using Windows Subsystem for Linux 2 (WSL2) instead of trying to run Ruby natively since it's a bit messy. You can check which version of Ruby is currently configured by running `ruby -v`.

You must also install:
- [PostgreSQL](https://www.postgresql.org/download/) &geq; 12
- [Redis](https://redis.io/) &geq; 5

### Getting Started
Once you have Ruby installed, run the following commands inside the checked out repo:
```bash
sudo apt install libpq-dev libsodium-dev # required for PostgreSQL gem's native extensions & JWT signing
gem install bundler # if not installed already
bundle install # install gems required by project
```

Once that's done, you will need to configure the database and storage. This is done by created a file called `secrets.json` in the `config` folder. An example file is shown below; you will of course need to substitute the information with your own.
```jsonc
{
  "aws": {
    "public": {
      "access_key_id": "your-access-key-id",
      "secret_access_key": "your-secret-access-key",
      "region": "ca-central-1",
      "bucket": "3dcloud-public"
    },
    "private": {
      "access_key_id": "your-access-key-id",
      "secret_access_key": "your-secret-access-key",
      "region": "ca-central-1",
      "bucket": "3dcloud-private"
    }
  },
  "database": {
    "username": "your-database-username",
    "password": "your-database-password",
    // if the database isn't running on the default local socket, you need to specify either
    "socket": "/var/run/postgresql/.s.PGSQL.5432",
    // or
    "host": "localhost",
    "port": 5432
  },
  "smtp": {
    "address": "mail.example.com",
    "port": 465,
    "tls": true,
    "user_name": "email@example.com",
    "password": "password"
  },
  "jwt_secret": "random 32 character string",
  "secret_key_base": "random string generated by `rails secret`",
  // redis can use either a socket (recommended)
  "redis_socket_path": "/var/run/redis/redis-server.sock",
  // or host/port
  "redis_host": "localhost",
  "redis_port": 6379
}
```

The entire `"aws"` object can be omitted if you want to use local storage instead.

Note that the database user needs the `CREATEDB` permission to set up the database. It will also require superuser access if you want to use Rails' `db:reset` command (since it drops the database).
For example:
```postgresql
CREATE ROLE "username" SUPERUSER CREATEDB LOGIN PASSWORD 'password'
```

You should then be able to run the server by executing
```
rails server
```

### Staging/Production Credentials
Credentials are stored using [ejson](https://github.com/Shopify/ejson) rather than Rails' built-in solution since the former offers more flexibility and improved security. To add a secret, simply open the configuration file (`secrets.staging.ejson`/`secrets.production.ejson`), edit the JSON, then run `ejson encrypt secrets.staging.json`/`ejson encrypt secrets.production.json` and commit the changes. Note that the secrets can only be decrypted using the private key stored on deployment servers, so you cannot retrieve encrypted values locally.
